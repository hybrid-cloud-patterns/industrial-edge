apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: cleanup
spec:
  workspaces:
  - name: gitrepos
    description: The git repo will be cloned onto the volume backing this workspace
  - name: config
    description: configmap contents
  params:
  - name: subdirectory
    description: subdirectory inside the "gitrepos" workspace to clone the git repo into
    type: string
    default: dev
  - name: COMPONENT_NAME
    description: component name
    type: string
  - name: NUMBER_OF_TAGS_TO_KEEP
    type: string
    default: "5"
  - name: GITHUB_USERNAME_CONFIGMAPKEY
    default: user
    type: string
  - name: GITHUB_TOKEN_CONFIGMAPKEY
    default: token
    type: string
  steps:
  - name: cleanup-git-tags
    image: gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd/git-init:v0.24.3
    script: |
      #list build tags for component in repo
      BUILD_TAG_GLOB="build-$(params.COMPONENT_NAME)-*"
      git tag --sort "version:refname" -l $BUILD_TAG_GLOB >/scratch/tags

      #identify build tags to keep
      tail -n $(params.NUMBER_OF_TAGS_TO_KEEP) /scratch/tags >/scratch/keep

      #identify build tags to be deleted
      diff /scratch/tags /scratch/keep | grep \^-build | cut -c2- > /scratch/delete

      #delete build tags
      for TAG in $(cat /scratch/delete); do
        git push origin :$TAG
        EXIT_CODE="$?"
        if [ "$EXIT_CODE" != 0 ]
        then
          exit $EXIT_CODE
        fi
      done
    volumeMounts:
    - mountPath: /scratch
      name: scratch
    workingDir: $(workspaces.gitrepos.path)/$(params.subdirectory)
  volumes:
  - emptyDir: {}
    name: scratch
